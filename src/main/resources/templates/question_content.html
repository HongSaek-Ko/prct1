<!DOCTYPE html>
<html layout:decorate="~{layout}">
  <!-- 전체를 하나의 container로 묶음, 세로 간격 3 -->
  <div layout:fragment="content" class="container my-3">
    <!-- 질문 제목, 밑줄 및 세로 들여쓰기 2 -->
    <h2 class="border-bottom py-2" th:text="${question.subject}"></h2>
    <!-- card 컴포넌트: 세로 간격 3-->
    <div class="card my-3">
      <!-- card body 시작 -->
      <div class="card-body">
        <!-- 질문 제목 -->
        <div
          class="card-text"
          style="white-space: pre-line"
          th:text="${question.content}"
        ></div>
        <!-- content 컴포넌트: 우측 정렬 -->
        <div class="d-flex justify-content-end">
          <div
            th:if="${question.modifyDate != null}"
            class="badge bg-light text-dark p-2 text-start mx-3"
          >
            <div class="mb-2">수정 일시</div>
            <div
              th:text="${#temporals.format(question.modifyDate, 'yyyy-MM-dd HH:mm')}"
            ></div>
          </div>
          <!-- badge 컴포넌트: 배경 하양, 글씨 검정, 들여쓰기 2, 좌측 정렬 -->
          <div class="badge bg-light text-dark p-2 text-start">
            <!-- 작성자 (있을 때만 렌더링) -->
            <div class="mb-2">
              <span
                th:if="${question.author != null}"
                th:text="${question.author.membername}"
              ></span>
            </div>
            <!-- 작성일자. %y-%m-%d hh:mm:ss 형식 -->
            <div
              th:text="${#temporals.format(question.createDate, 'yyyy-MM-dd HH:mm')}"
            ></div>
          </div>
          <!-- badge 컴포넌트 끝 -->
        </div>
        <!-- content 컴포넌트 끝 -->
      </div>
      <!-- card body 끝 -->
    </div>
    <!-- card 컴포넌트 끝 -->
    <!-- 추천/수정/삭제 버튼 시작 -->
    <div class="my-3">
      <!-- javascript:void(0): 아무 동작도 하지 않음 -->
      <!-- recommend 속성 - 자바스크립트를 사용하여 data-url에 정의된 url이 호출되도록 함 (추천 시 사용자 확인 구하기) -->
      <!-- 추천 시작 -->
      <a
        href="javascript:void(0);"
        class="recommend btn btn-sm btn-outline-secondary"
        th:data-url="@{|/question/vote/${question.id}|}"
        >추천
        <span
          class="badge rounded-pill bg-success"
          th:text="${#lists.size(question.recommender)}"
        ></span>
      </a>
      <!-- 추천 끝 -->
      <!-- 수정/삭제: (현재 접속한)사용자 == 작성자일 때만 표시 -->
      <!-- th:data-url 속성 - 삭제 버튼 클릭 시 확인 절차 필요 -->
      <a
        th:href="@{|/question/modify/${question.id}|}"
        class="btn btn-sm btn-outline-secondary"
        sec:authorize="isAuthenticated()"
        th:if="${question.author != null AND #authentication.getPrincipal().getMembername() == question.author.membername}"
        th:text="수정"
      ></a>
      <a
        href="javascript:void(0);"
        th:data-url="@{|/question/delete/${question.id}|}"
        class="delete btn btn-sm btn-outline-secondary"
        sec:authorize="isAuthenticated()"
        th:if="${question.author != null AND #authentication.getPrincipal().getMembername() == question.author.membername}"
        th:text="삭제"
      ></a>
    </div>
    <!-- 추천/수정/삭제 버튼 끝 -->

    <!-- 답변 개수 -->
    <!-- #lists.size(이터러블 객체) - thymeleaf의 유틸리티. 객체의 길이 반환 -->
    <h5
      class="border-bottom my-3 py-2"
      th:text="|${#lists.size(question.answerList)}개의 답변이 있습니다.|"
    ></h5>
    <!-- 답변 목록(카드) 시작-->
    <div class="card my-3" th:each="answer : ${question.answerList}">
      <div class="card-body">
        <div
          class="card-text"
          style="white-space: pre-line"
          th:text="${answer.content}"
        >
          <!-- 시간 데이터 시작 -->
          <div class="d-flex justify-content-end">
            <!-- 수정 일시 -->
            <div
              th:if="${question.modifyDate != null}"
              class="badge bg-light text-dark p-2 text-start mx-3"
            >
              <div class="mb-2">수정 일시</div>
              <div
                th:text="${#temporals.format(question.modifyDate, 'yyyy-MM-dd HH:mm')}"
              ></div>
            </div>
            <!-- 수정 일시 끝 -->
            <!-- 작성 일시 -->
            <div class="badge bg-light text-dark p-2 text-start">
              <div class="mb-2">
                <span
                  th:if="${question.author != null}"
                  th:text="${question.author.membername}"
                ></span>
              </div>
              <div
                th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm:ss')}"
              ></div>
            </div>
            <!-- 작성 일시 끝 -->
          </div>
          <!-- 시간 데이터 끝 -->
          <!-- 답변 수정/삭제: (현재 접속한)사용자 == 작성자일 때만 표시 -->
          <div class="my-3">
            <a
              th:href="@{|/answer/modify/${answer.id}|}"
              class="btn btn-sm btn-outline-secondary"
              sec:authorize="isAuthenticated()"
              th:if="${answer.author != null AND #authentication.getPrincipal().getMembername() == answer.author.membername}"
              th:text="수정"
            ></a>
            <!-- th:data-url 속성 - 삭제 버튼 클릭 시 확인 절차 필요 -->
            <a
              href="javascript:void(0)"
              th:data-url="@{|/answer/delete/${answer.id}|}"
              class="delete btn btn-sm btn-outline-secondary"
              sec:authorize="isAuthenticated()"
              th:if="${answer.author != null AND #authentication.getPrincipal().getMembername() == answer.author.membername}"
              th:text="삭제"
            ></a>
          </div>
        </div>
      </div>
    </div>
    <!-- 답변 목록(카드) 끝 -->
    <!-- 답변 작성 폼. th:action 태그로 작성. 문자열-객체 연결 시 | 표기 필수. -->
    <form
      class="my-3"
      th:action="@{|answer/regist/${question.id}|}"
      th:object="${answerForm}"
      method="post"
    >
      <!-- 에러 메시지 시작. 에러 발생 시에만 표시 -->
      <div th:replace="form_errors :: formErrorsFragment"></div>
      <!-- 에러 메시지 끝 -->
      <!-- 작성 범위. name={컬럼명}. rows=박스 크기 설정값. -->
      <!-- 비로그인(Anonymous)일때는 disabled-->
      <textarea
        sec:authorize="isAnonymous()"
        disabled
        class="form-control"
        th:field="*{content}"
        id="content"
        rows="5"
      ></textarea>
      <textarea
        sec:authorize="isAuthenticated()"
        class="form-control"
        th:field="*{content}"
        id="content"
        rows="10"
      ></textarea>
      <!-- '답변등록' 클릭 시 POST 방식으로 제출(submit)됨 -->
      <input class="btn btn-primary my-2" type="submit" value="답변등록" />
    </form>
  </div>
  <!-- container 끝 -->
  <!-- 자바스크립트 -->
  <script layout:fragment="script" type="text/javascript">
    // 삭제 확인 시작
    const delete_elements = document.getElementsByClassName("delete");
    Array.from(delete_elements).forEach(function (element) {
      element.addEventListener("click", function () {
        if (confirm("정말로 삭제하시겠어요?")) {
          location.href = this.dataset.uri;
        }
      });
    });
    // 삭제 확인 끝
  </script>
</html>
